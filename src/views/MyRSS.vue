<template>
  <!-- Custom RSS Link-->
  <div class="form-control p-4 flex flex-col gap-4 bg-base-100 rounded-box">
    <label class="input-group input-group-sm">
      <span>
        <svg class="w-4" width="21" height="19" viewBox="0 0 21 19" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path class="fill-base-content" d="M10.5431 15.081C10.6051 15.0997 10.6465 15.1372 10.6671 15.1934C10.6878 15.2495 10.6775 15.3057 10.6361 15.3619L8.06307 17.6937C7.64972 18.0682 7.17437 18.3679 6.63702 18.5926C6.09967 18.8174 5.55199 18.9485 4.99397 18.986C4.43595 19.0234 3.87794 18.986 3.31992 18.8736C2.7619 18.7612 2.25555 18.5271 1.80087 18.1712C1.24286 17.7779 0.808843 17.3004 0.498834 16.7385C0.188824 16.1766 0.0234856 15.6148 0.00281827 15.0529C-0.017849 14.491 0.0751538 13.9198 0.281827 13.3392C0.4885 12.7586 0.839844 12.2529 1.33586 11.8222L5.33498 8.19813C5.97567 7.61754 6.71969 7.18677 7.56705 6.90584C8.41441 6.62491 9.28244 6.54999 10.1711 6.68109C10.9565 6.79347 11.5765 6.99948 12.0312 7.29915C12.4859 7.59881 12.8475 7.94529 13.1162 8.3386C13.1576 8.43224 13.1524 8.50248 13.1007 8.5493C13.0491 8.59612 12.9922 8.63826 12.9302 8.67572C12.8682 8.71317 12.7959 8.76936 12.7132 8.84428L12.4962 9.04093C12.2895 9.24695 12.0415 9.34996 11.7522 9.34996C11.4628 9.34996 11.1993 9.24226 10.9617 9.02688C10.724 8.8115 10.4605 8.64762 10.1711 8.53525C9.88179 8.42288 9.56145 8.37606 9.2101 8.39478C8.85876 8.41351 8.54875 8.46034 8.28007 8.53525C8.0114 8.61017 7.73239 8.77873 7.44305 9.04093L2.85491 13.1987C2.58623 13.4422 2.38989 13.7231 2.26589 14.0415C2.14188 14.3599 2.10055 14.6783 2.14188 14.9967C2.18322 15.3151 2.28656 15.6335 2.45189 15.9519C2.61723 16.2703 2.88591 16.5231 3.25792 16.7104C3.7746 17.0288 4.33262 17.1412 4.93197 17.0475C5.53132 16.9539 6.03767 16.7291 6.45102 16.3733L8.43508 14.6034C8.47641 14.5472 8.53841 14.5379 8.62108 14.5753C9.2411 14.8188 9.88179 14.9873 10.5431 15.081ZM19.1614 0.865784C19.7194 1.25909 20.1534 1.72731 20.4634 2.27045C20.7735 2.81359 20.9491 3.37545 20.9905 3.95605C21.0318 4.53664 20.9388 5.11723 20.7115 5.69783C20.4841 6.27842 20.1224 6.7841 19.6264 7.21487L15.6273 10.8389C14.9866 11.4195 14.2426 11.8409 13.3952 12.1031C12.5479 12.3653 11.6695 12.4402 10.7601 12.3278C9.97479 12.2342 9.36511 12.0282 8.93109 11.7098C8.49708 11.3914 8.1354 11.0449 7.84606 10.6703C7.80472 10.5954 7.81506 10.5299 7.87706 10.4737L8.43508 9.96801C8.66242 9.78072 8.92076 9.68708 9.2101 9.68708C9.49944 9.68708 9.74745 9.78072 9.95412 9.96801C10.2021 10.1928 10.4811 10.3613 10.7912 10.4737C11.1012 10.5861 11.4215 10.6422 11.7522 10.6422C12.0829 10.6422 12.4032 10.5861 12.7132 10.4737C13.0232 10.3613 13.2919 10.1928 13.5192 9.96801L18.1074 5.8383C18.376 5.59482 18.5724 5.30452 18.6964 4.9674C18.8204 4.63028 18.8617 4.30253 18.8204 3.98414C18.7791 3.66575 18.6654 3.35672 18.4794 3.05706C18.2934 2.7574 18.0247 2.50456 17.6734 2.29854C17.1773 1.99888 16.6297 1.88651 16.0303 1.96142C15.431 2.03634 14.9143 2.27045 14.4803 2.66375L12.5272 4.43363C12.4652 4.48982 12.4032 4.49918 12.3412 4.46172C11.7625 4.23698 11.1218 4.05905 10.4191 3.92795C10.3365 3.92795 10.2951 3.89049 10.2951 3.81558C10.2951 3.74066 10.3055 3.69384 10.3261 3.67511L12.8992 1.34337C13.3126 0.968793 13.7879 0.669131 14.3253 0.444385C14.8626 0.219638 15.4 0.079172 15.9373 0.0229854C16.4747 -0.0332012 17.0327 0.013621 17.6114 0.163452C18.19 0.313283 18.7067 0.547393 19.1614 0.865784Z" fill="#B7E9FF" fill-opacity="0.6"/>
        </svg>
      </span>
      <input ref="newSourceInput" v-model="newSourceUrl" name="link" type="text" placeholder="Add ur custom rss link here" class="input input-bordered input-sm w-full" required />
    </label>
    <div class="flex flex-wrap items-center gap-2">
      <!-- Dropdown RSS sources -->
      <TreeSelect
        v-model="selectedSource"
        placeholder="Select specific rss"
        :options="options"
        @delete:option="removeSource"
        @addOption="newSourceInput.focus()"
      />
      <div v-if="rssStore.selectedSource?.notSaved" class="tooltip tooltip-accent tooltip-right" data-tip="Save as">
        <label for="save-source" @click="authStore.action = 'save-source'" class="btn btn-circle btn-accent btn-sm">
          +
        </label>
      </div>
      <button v-if="myRss.length < maxSource" @click="rssStore.setSource(newSourceUrl)" class="btn btn-accent ml-auto">Add</button>
      <router-link v-else to="/upgrades" class="btn btn-accent ml-auto">Add</router-link>
    </div>
  </div>

  <ul class="space-y-4 mt-4 pb-2">
    <div
      v-for="(news, index) in rssStore.datas.items"
      :key="index"
      class="ease flex gap-4 items-center justify-between bg-base-100 rounded-box p-3 hover:bg-base-200"
      :class="rssIds && rssIds.includes(news.link) ? 'border border-accent' : ''"
    >
      <a :href="news.link" target="_blank" class="flex flex-wrap gap-4 w-full group">
        <div class="avatar max-w-full max-h-32 md:max-w-[12rem]">
          <img v-if="news.enclosure.link" class="rounded-lg" :src="news.enclosure.link" :alt="`News image ${index}`" />
          <div v-else class="bg-base-300 rounded-lg w-[12rem]"></div>
        </div>
        <div class="flex-col flex-[2]">
          <div class="flex gap-2 items-center">
            <svg class="w-6 h-6 min-w-min" width="34" height="34" viewBox="0 0 34 34" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M31.2015 12.6249C31.7488 11.1466 31.9068 9.737 31.5136 8.47194C31.3325 8.48825 31.1446 8.49669 30.9523 8.49669C25.1911 8.49669 15.0088 1.25338 14.2381 0.125C11.0628 4.75044 4.40733 8.30656 1.39908 12.2947C0.181832 13.9085 -0.426793 15.1094 0.784269 16.9556L13.4681 33.2529C14.0401 34.0274 15.1612 34.0904 15.9594 33.3761C15.9594 33.3761 26.3611 20.0285 33.8756 15.8986C33.3108 14.7956 32.3709 13.6948 31.2015 12.6249M13.247 29.7991L13.1941 29.8357L13.1463 29.8773C12.9525 30.0512 12.7802 30.2478 12.6333 30.4629L1.64321 16.3424C0.851769 15.1179 1.07621 14.4732 2.24114 12.9297C3.56246 11.1787 5.67408 9.47881 7.91002 7.67938C10.2343 5.8085 12.6283 3.8825 14.3866 1.691C17.2891 4.07937 25.4077 9.35281 30.6609 9.54575C31.2909 15.7316 18.4648 26.1598 13.247 29.7991" fill="currentColor" fill-opacity="0.5"/>
              <path d="M10.246 6.96384L24.4238 18.0732L24.9289 17.621L10.615 6.63309L10.246 6.96384ZM14.8664 12.8774L9.06363 8.0219C9.06363 8.0219 7.04426 9.31115 4.59851 12.1388L9.74651 17.4612L14.8664 12.8774M2.15332 14.7837L13.1041 28.2055L15.1263 26.396L3.45101 13.0473C3.45101 13.0473 2.43345 13.598 2.15332 14.7837ZM14.4237 15.5532L20.785 21.3301L22.8061 19.5205L16.1826 13.9788L14.4237 15.5532ZM10.9058 18.7027L16.7429 24.9487L18.7634 23.1397L12.6648 17.1282L10.9058 18.7027ZM14.6695 5.05022L13.8117 7.45884L14.3494 7.85034L17.0804 5.40515L16.546 5.06878L14.6644 6.75347L15.4964 4.40559L14.9384 4.05347L12.3357 6.38334L12.802 6.72253L14.6695 5.05022ZM17.0067 9.78815L17.5276 9.32072L15.9385 8.19122L16.6591 7.54659L18.0704 8.51297L18.5716 8.06353L17.1445 7.11065L17.7396 6.57853L19.3197 7.60059L19.8327 7.14215L17.6479 5.7629L14.8816 8.23959L17.0067 9.78815ZM18.6993 11.0212L20.8587 9.71334L21.5658 9.26559L21.0966 9.87197L19.7073 11.7569L20.3783 12.2457L24.5341 10.1088L23.7454 9.61097L21.4668 10.9148L20.8851 11.267L21.2755 10.7534L22.6261 8.90447L21.8678 8.42634L19.7613 9.7319L19.2016 10.0857L19.5869 9.59578L20.8626 7.79184L20.1516 7.34297L18.0923 10.579L18.6993 11.0212ZM26.5101 11.209C25.9988 10.8878 25.5213 10.7343 25.0746 10.7433C24.6314 10.7528 24.268 10.8862 23.9817 11.1427C23.6673 11.4239 23.5615 11.7158 23.665 12.0185C23.7258 12.2002 23.9193 12.4628 24.2494 12.8105L24.5909 13.1693C24.7945 13.3808 24.9256 13.5541 24.9829 13.6868C25.0392 13.8213 25.0116 13.9388 24.9008 14.0378C24.7113 14.2072 24.4643 14.2392 24.1611 14.1357C23.9726 14.0642 23.795 13.9667 23.6335 13.846C23.3129 13.6177 23.1571 13.3977 23.161 13.1857C23.1633 13.0698 23.2268 12.937 23.3511 12.7874L22.6137 12.2733C22.2813 12.5708 22.1553 12.9027 22.2385 13.2712C22.3223 13.643 22.6075 14.0097 23.1025 14.3708C23.5958 14.7325 24.0869 14.926 24.5695 14.9474C25.0572 14.9682 25.4588 14.84 25.7682 14.5615C26.0719 14.2904 26.1799 13.999 26.0933 13.6891C26.0382 13.4905 25.8835 13.2593 25.6338 12.9961L25.0741 12.4055C24.8609 12.1827 24.7338 12.028 24.6904 11.9397C24.6229 11.8053 24.6471 11.6866 24.7636 11.5831C24.8901 11.4695 25.0521 11.4233 25.2501 11.443C25.4509 11.4627 25.6602 11.5432 25.879 11.6838C26.0776 11.812 26.2176 11.9448 26.2958 12.082C26.4168 12.289 26.383 12.4887 26.1974 12.6783L27.0282 13.2256C27.3736 12.8926 27.4816 12.5399 27.3528 12.1692C27.2268 11.8019 26.9449 11.4813 26.5101 11.209" fill="currentColor" fill-opacity="0.5"/>
            </svg>
            <span v-if="rssStore.selectedSource" class="text-sm text-accent lg:max-w-[15rem] truncate">{{ rssStore.selectedSource.name }}</span>
            <ReadLaterButton :news="{ ...news, saved: rssIds && rssIds.includes(news.link), name: rssStore.selectedSource?.name }" :needToStore="true" class="ml-auto" />
          </div>
          <div class="pr-12">
            <i v-if="news.pubDate" class="text-xs opacity-50">{{ new Date(news.pubDate).toLocaleString() }}</i>
            <i v-else class="text-xs opacity-50">Date not specified</i>
            <p class="text-sm font-bold group-hover:link flex-1">{{ news.title }}</p>
          </div>
        </div>
      </a>
    </div>
  </ul>

  <Teleport v-if="rssStore.error" to="#alert-container">
    <div class="alert alert-error shadow-lg">
      <div>
        <svg @click="rssStore.error = false" xmlns="http://www.w3.org/2000/svg" class="cursor-pointer stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span>A problem occurred with the provided rss link</span>
      </div>
    </div>
  </Teleport>

  <Teleport v-if="authStore.action === 'save-source'" to="#modal-container">
    <input type="checkbox" id="save-source" class="modal-toggle" ref="save-source" @change="authStore.closeModal(!$event.target.checked)" />
    <label for="save-source" class="modal cursor-pointer">
      <label class="modal-box relative" for="">
        <label for="save-source" class="btn btn-sm btn-circle absolute right-2 top-2">✕</label>
        <h3 class="text-lg font-bold">Save source</h3>
        <form @submit.prevent class="flex flex-col">
          <p class="font-extralight mt-2"><i>Choose a name to give to your rss source to remember it and reuse it later</i></p>
          <div class="form-control w-full">
            <label class="label">
              <span class="label-text">Source name</span>
            </label>
            <input v-model="name" type="text" placeholder="Type here" class="input input-bordered w-full" required />
          </div>
          <div class="flex gap-2 w-full justify-end mt-4">
            <label for="save-source" class="btn btn-error btn-outline">Cancel</label>
            <button @click="saveSourceAs(name); $refs['save-source'].checked = false;" type="submit" class="btn btn-success">Save</button>
          </div>
        </form>
      </label>
    </label>
  </Teleport>
</template>

<script setup>
import { defineAsyncComponent, ref, watch, toRefs, onMounted, inject, computed, onBeforeMount } from 'vue'
import { useRSSStore } from '@/stores/rssStore'
import { supabase } from '@/utils/supabase'

const TreeSelect = defineAsyncComponent(() => import('@/components/Inputs/TreeSelect.vue'))
const ReadLaterButton = defineAsyncComponent(() => import('@/components/RSS/ReadLaterButton.vue'))

const rssStore = useRSSStore()
const { selectedSource } = toRefs(rssStore)

const authStore = inject('authStore')
const { rssIds } = toRefs(authStore)

const newSourceUrl = ref('')
const name = ref('')
const newSourceInput = ref('')

const maxSource = ref(authStore.myPlan.rss)

watch(selectedSource, (newSource) => {
  if (newSource) {
    rssStore.fetchRssFeed(newSource)
  }
})

const options = computed(() => {
  return [
    ...rssStore.sources,
    {
      name: 'MyRSS',
      open: true,
      removeOption: true,
      children: myRss.value
    }
  ]
})

const myRss = ref([])
const getMyRSS = async () => {
  const { data, error } = await supabase
  .from('profiles')
  .select('my_rss')
  .eq('user_id', authStore.user.userId)
  .single()
  if (!error) {
    myRss.value = data.my_rss?.slice(0, maxSource.value) || []
    if (!rssStore.selectedSource) loadRandomRSS()
  }
}

const loadRandomRSS = () => {
  const r = Math.floor(Math.random() * myRss.value.length)
  rssStore.selectedSource = myRss.value.length ? myRss.value[r] : null
}

const saveSourceAs = async (name) => {
  const nameAlreadyTaken = myRss.value.filter(r => r.name === name)
  if (nameAlreadyTaken.length) return

  delete rssStore.selectedSource.notSaved
  const newSource = { ...rssStore.selectedSource, name }
  myRss.value.push(newSource)
  rssStore.selectedSource = newSource

  await supabase
    .from('profiles')
    .update({ my_rss: myRss.value })
    .eq('user_id', authStore.user.userId)
}

const removeSource = async (source) => {
  myRss.value = myRss.value.filter(child => child.name !== source.name)
  await supabase
    .from('profiles')
    .update({ my_rss: myRss.value })
    .eq('user_id', authStore.user.userId)

  if (rssStore.selectedSource && source.url === rssStore.selectedSource.url) {
    rssStore.selectedSource = null
    rssStore.datas = []
  }
}

onMounted(async () => {
  getMyRSS()
  await authStore.getRssIds()
})
</script>
